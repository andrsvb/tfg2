<html>
<head>
<title>tfscan_pyex.ipynb</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #6a8759;}
.s4 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
tfscan_pyex.ipynb</font>
</center></td></tr></table>
<pre><span class="s0">#%% md 
</span><span class="s1"># tests de las funciones de 'escanear examenes' de pyexams 
</span><span class="s0">#%% 
</span><span class="s2">import </span><span class="s1">PyPDF2 </span><span class="s2">as </span><span class="s1">pypdf</span>
<span class="s2">import </span><span class="s1">json</span>
<span class="s2">import </span><span class="s1">os</span>
<span class="s2">from </span><span class="s1">pdf2image </span><span class="s2">import </span><span class="s1">convert_from_path</span>
<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">import </span><span class="s1">cv2</span>
<span class="s2">from </span><span class="s1">functools </span><span class="s2">import </span><span class="s1">reduce</span>
<span class="s2">import </span><span class="s1">sys</span>
<span class="s0">#%% 
</span><span class="s2">import </span><span class="s1">matplotlib.pyplot </span><span class="s2">as </span><span class="s1">plt</span>
<span class="s1">debug = </span><span class="s2">True</span>
<span class="s0">#%% 
</span><span class="s2">def </span><span class="s1">detect_filled(boxes</span><span class="s2">, </span><span class="s1">exam</span><span class="s2">, </span><span class="s1">variant):</span>
    <span class="s1">data = {</span><span class="s3">'exam'</span><span class="s1">: exam</span><span class="s2">,</span>
            <span class="s3">'variant'</span><span class="s1">: variant</span><span class="s2">,</span>
            <span class="s3">'num_boxes'</span><span class="s1">: boxes.__len__()</span><span class="s2">,</span>
            <span class="s3">'exercises'</span><span class="s1">: []}</span>
    <span class="s1">count_ex = -</span><span class="s4">1</span>
    <span class="s1">count_box = -</span><span class="s4">1</span>
    <span class="s1">count_page = </span><span class="s4">1</span>
    <span class="s1">last_y = sys.float_info.max</span>
    <span class="s2">for </span><span class="s1">box </span><span class="s2">in </span><span class="s1">boxes:</span>
        <span class="s1">exercise = box.split(sep=</span><span class="s3">':'</span><span class="s1">)[</span><span class="s4">2</span><span class="s1">]</span>
        <span class="s2">if not </span><span class="s1">data[</span><span class="s3">'exercises'</span><span class="s1">] </span><span class="s2">or </span><span class="s1">(data[</span><span class="s3">'exercises'</span><span class="s1">][count_ex][</span><span class="s3">'exercise'</span><span class="s1">] != exercise):</span>
            <span class="s1">count_ex = count_ex + </span><span class="s4">1</span>
            <span class="s1">count_box = -</span><span class="s4">1</span>
            <span class="s1">data[</span><span class="s3">'exercises'</span><span class="s1">].append(</span>
                <span class="s1">{</span>
                    <span class="s3">'exercise'</span><span class="s1">: exercise</span><span class="s2">,</span>
                    <span class="s3">'checkboxes'</span><span class="s1">: []</span>
                <span class="s1">}</span>
            <span class="s1">)</span>
            <span class="s1">data[</span><span class="s3">'exercises'</span><span class="s1">][count_ex][</span><span class="s3">'student_marked'</span><span class="s1">] = []</span>
        <span class="s1">x1</span><span class="s2">, </span><span class="s1">y1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">, </span><span class="s1">y2 = [float(i) </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">boxes[box][</span><span class="s3">'/Rect'</span><span class="s1">]]</span>
        <span class="s2">if </span><span class="s1">y1 &gt; last_y:</span>
            <span class="s1">count_page = count_page + </span><span class="s4">1</span>
        <span class="s1">last_y = y1</span>
        <span class="s1">count_box = count_box + </span><span class="s4">1</span>
        <span class="s1">data[</span><span class="s3">'exercises'</span><span class="s1">][count_ex][</span><span class="s3">'checkboxes'</span><span class="s1">].append(</span>
            <span class="s1">{</span>
                <span class="s3">'checkbox'</span><span class="s1">: str(count_ex) + </span><span class="s3">',' </span><span class="s1">+ str(count_box)</span><span class="s2">,</span>
                <span class="s3">'cords'</span><span class="s1">: [x1</span><span class="s2">, </span><span class="s1">y1</span><span class="s2">, </span><span class="s1">round(x2 - x1</span><span class="s2">, </span><span class="s4">3</span><span class="s1">)</span><span class="s2">, </span><span class="s1">round(y2 - y1</span><span class="s2">, </span><span class="s4">3</span><span class="s1">)]</span><span class="s2">,</span>
                <span class="s3">'page'</span><span class="s1">: count_page</span>
            <span class="s1">})</span>
        <span class="s2">if </span><span class="s1">boxes[box][</span><span class="s3">'/V'</span><span class="s1">] == </span><span class="s3">'/Yes'</span><span class="s1">:</span>
            <span class="s1">data[</span><span class="s3">'exercises'</span><span class="s1">][count_ex][</span><span class="s3">'student_marked'</span><span class="s1">].append(str(count_ex) + </span><span class="s3">',' </span><span class="s1">+ str(count_box))</span>
    <span class="s2">return </span><span class="s1">data</span>
<span class="s0">#%% 
</span><span class="s2">def </span><span class="s1">find_qrs(file</span><span class="s2">, </span><span class="s1">dpi):</span>
    <span class="s0"># TODO: improve qr detection</span>
    <span class="s1">pages = convert_from_path(file</span><span class="s2">, </span><span class="s1">dpi=dpi</span><span class="s2">, </span><span class="s1">thread_count=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">fmt=</span><span class="s3">'png'</span><span class="s1">)</span>
    <span class="s1">img_file = </span><span class="s3">'img_temp.png'</span>
    <span class="s1">qrs = []</span>
    <span class="s2">for </span><span class="s1">page </span><span class="s2">in </span><span class="s1">pages:</span>
        <span class="s1">page.save(img_file)</span>
        <span class="s1">img = cv2.imread(img_file)</span>
        <span class="s1">qr_detect = cv2.QRCodeDetector()</span>
        <span class="s0"># process the image</span>
        <span class="s1">_</span><span class="s2">, </span><span class="s1">img_th = cv2.threshold(img</span><span class="s2">, </span><span class="s4">120</span><span class="s2">, </span><span class="s4">255</span><span class="s2">, </span><span class="s1">cv2.THRESH_BINARY)</span>
        <span class="s0"># keep only black pixels</span>
        <span class="s1">hsv_img = cv2.cvtColor(img_th</span><span class="s2">, </span><span class="s1">cv2.COLOR_BGR2HSV)</span>
        <span class="s1">lower_values = np.array([</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0</span><span class="s1">])</span>
        <span class="s1">upper_values = np.array([</span><span class="s4">180</span><span class="s2">,</span><span class="s4">255</span><span class="s2">,</span><span class="s4">30</span><span class="s1">])</span>
        <span class="s1">black_mask = cv2.inRange(hsv_img</span><span class="s2">, </span><span class="s1">lower_values</span><span class="s2">, </span><span class="s1">upper_values)</span>
        <span class="s0"># blur, sharpen and recognize the qr</span>
        <span class="s1">blur = cv2.GaussianBlur(black_mask</span><span class="s2">, </span><span class="s1">(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s1">)</span><span class="s2">, </span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">sharpen = cv2.filter2D(blur</span><span class="s2">, </span><span class="s1">-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">np.array([[-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">]]))</span>
        <span class="s1">value</span><span class="s2">, </span><span class="s1">coordinates</span><span class="s2">, </span><span class="s1">qr = qr_detect.detectAndDecode(~sharpen)</span>
        <span class="s0"># if it doesn't find the qr, loop blur and sharpen until it does, up to 5 times</span>
        <span class="s1">count = </span><span class="s4">0</span>
        <span class="s2">while </span><span class="s1">qr </span><span class="s2">is None</span><span class="s1">:</span>
            <span class="s2">if </span><span class="s1">count == </span><span class="s4">5</span><span class="s1">:</span>
                <span class="s1">print(</span><span class="s3">'Error: QR not found'</span><span class="s1">)</span>
                <span class="s2">break</span>
            <span class="s1">blur = cv2.GaussianBlur(sharpen</span><span class="s2">, </span><span class="s1">(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s1">)</span><span class="s2">, </span><span class="s4">0</span><span class="s1">)</span>
            <span class="s1">sharpen = cv2.filter2D(blur</span><span class="s2">, </span><span class="s1">-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">np.array([[-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">]]))</span>
            <span class="s1">value</span><span class="s2">, </span><span class="s1">coordinates</span><span class="s2">, </span><span class="s1">qr = qr_detect.detectAndDecode(~sharpen)</span>
            <span class="s1">count = count + </span><span class="s4">1</span>
        <span class="s1">exam</span><span class="s2">, </span><span class="s1">variant</span><span class="s2">, </span><span class="s1">page = </span><span class="s3">''</span><span class="s2">, </span><span class="s3">''</span><span class="s2">, </span><span class="s3">''</span>
        <span class="s2">if </span><span class="s1">value:</span>
            <span class="s1">exam</span><span class="s2">, </span><span class="s1">variant</span><span class="s2">, </span><span class="s1">page = value.split(sep=</span><span class="s3">','</span><span class="s1">)</span>
        <span class="s1">qrs.append({</span><span class="s3">'exam'</span><span class="s1">: exam</span><span class="s2">, </span><span class="s3">'variant'</span><span class="s1">: variant</span><span class="s2">, </span><span class="s3">'page'</span><span class="s1">: page</span><span class="s2">, </span><span class="s3">'coordinates'</span><span class="s1">: coordinates})</span>
    <span class="s2">if </span><span class="s1">os.path.exists(img_file):</span>
        <span class="s1">os.remove(img_file)</span>
    <span class="s2">return </span><span class="s1">qrs</span>
<span class="s0">#%% 
</span><span class="s2">def </span><span class="s1">analyse(file</span><span class="s2">, </span><span class="s1">sol_json=</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s1">dpi=</span><span class="s4">300</span><span class="s1">):</span>
    <span class="s0"># TODO: check if all qrs are from the same exam and variant</span>
    <span class="s0"># TODO: deal with the JSON file parameter</span>
    <span class="s0"># check if pyPDF2 can detect the boxes</span>
    <span class="s1">boxes = pypdf.PdfFileReader(file).getFields()</span>
    <span class="s0"># find qrs in the pdf</span>
    <span class="s1">qr_codes = find_qrs(file</span><span class="s2">, </span><span class="s1">dpi)</span>
    <span class="s1">exam</span><span class="s2">, </span><span class="s1">variant = qr_codes[</span><span class="s4">0</span><span class="s1">][</span><span class="s3">'exam'</span><span class="s1">]</span><span class="s2">, </span><span class="s1">qr_codes[</span><span class="s4">0</span><span class="s1">][</span><span class="s3">'variant'</span><span class="s1">]</span>
    <span class="s2">if </span><span class="s1">boxes:</span>
        <span class="s0"># extract marked boxes with pyPDF2</span>
        <span class="s1">data = detect_filled(boxes</span><span class="s2">, </span><span class="s1">exam</span><span class="s2">, </span><span class="s1">variant)</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s0"># extract marked boxes with OpenCV</span>
        <span class="s1">data = analyse_scanned(file</span><span class="s2">, </span><span class="s1">dpi</span><span class="s2">, </span><span class="s1">qr_codes)</span>
    <span class="s0"># TODO: open JSON file</span>
    <span class="s0"># TODO: compare with the data extracted from the pdf</span>
    <span class="s0"># TODO: grade the exam and export the grade</span>
    <span class="s2">return </span><span class="s1">data</span>
<span class="s0">#%% 
</span><span class="s2">def </span><span class="s1">analyse_scanned(file</span><span class="s2">, </span><span class="s1">dpi</span><span class="s2">, </span><span class="s1">qr_codes):</span>
    <span class="s1">img_file = </span><span class="s3">'img_temp.png'</span>
    <span class="s1">data = {</span><span class="s3">'exam'</span><span class="s1">: qr_codes[</span><span class="s4">0</span><span class="s1">][</span><span class="s3">'exam'</span><span class="s1">]</span><span class="s2">, </span><span class="s3">'variant'</span><span class="s1">: qr_codes[</span><span class="s4">0</span><span class="s1">][</span><span class="s3">'variant'</span><span class="s1">]</span><span class="s2">, </span><span class="s3">'num_boxes'</span><span class="s1">: </span><span class="s4">0</span><span class="s2">, </span><span class="s3">'boxes'</span><span class="s1">: []}</span>
    <span class="s1">pages_data = []</span>
    <span class="s1">pages = convert_from_path(file</span><span class="s2">, </span><span class="s1">dpi)</span>
    <span class="s2">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">page </span><span class="s2">in </span><span class="s1">enumerate(pages):</span>
        <span class="s1">page.save(img_file)</span>
        <span class="s1">pages_data.append(analyse_page(img_file</span><span class="s2">, </span><span class="s1">dpi</span><span class="s2">, </span><span class="s1">qr_codes[i][</span><span class="s3">'page'</span><span class="s1">]</span><span class="s2">, </span><span class="s1">qr_codes[i][</span><span class="s3">'coordinates'</span><span class="s1">]))</span>
    <span class="s1">pages_data.sort(key=</span><span class="s2">lambda </span><span class="s1">k: k[</span><span class="s3">'page'</span><span class="s1">])</span>
    <span class="s0"># TODO: add 'num_boxes' value to dict</span>
    <span class="s1">count = </span><span class="s4">0</span>
    <span class="s2">for </span><span class="s1">page </span><span class="s2">in </span><span class="s1">pages_data:</span>
        <span class="s1">count = count + page[</span><span class="s3">'boxes'</span><span class="s1">].__len__()</span>
        <span class="s2">for </span><span class="s1">box </span><span class="s2">in </span><span class="s1">page[</span><span class="s3">'boxes'</span><span class="s1">]:</span>
            <span class="s1">data[</span><span class="s3">'boxes'</span><span class="s1">].append(box)</span>
    <span class="s1">data[</span><span class="s3">'num_boxes'</span><span class="s1">] = count</span>
    <span class="s2">return </span><span class="s1">data</span>
<span class="s0">#%% md 
</span><span class="s1">data = [{'exam': qr_codes[i]['exam'], 'variant': qr_codes[i]['variant'], 'page': qr_codes[i]['page'], 'boxes': page} for i, page in enumerate(boxes)] 
 
genera: 
 
[{'exam': 'test_qr', 
  'variant': '11111', 
  'page': '1', 
  'boxes': {'exam': 'test_qr', 
   'variant': '11111', 
   'page': '1', 
   'boxes': [{'stats': [400, 1840, 46, 48], 'is_marked': True}, 
    {'stats': [400, 1905, 46, 47], 'is_marked': False}, 
    {'stats': [400, 2079, 46, 47], 'is_marked': False}, 
    {'stats': [400, 2142, 46, 47], 'is_marked': True}, 
    {'stats': [400, 2311, 47, 48], 'is_marked': True}, 
    {'stats': [400, 2376, 47, 46], 'is_marked': False}, 
    {'stats': [400, 2542, 47, 49], 'is_marked': True}, 
    {'stats': [400, 2607, 47, 47], 'is_marked': False}, 
</span><span class="s0">#%% 
</span><span class="s2">def </span><span class="s1">is_valid_box(x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">w</span><span class="s2">, </span><span class="s1">h</span><span class="s2">, </span><span class="s1">qr_points</span><span class="s2">, </span><span class="s1">line_min_width</span><span class="s2">, </span><span class="s1">a_height</span><span class="s2">, </span><span class="s1">stats):</span>
    <span class="s1">inside_qr = (qr_points[</span><span class="s4">0</span><span class="s1">] - line_min_width &lt; x &lt; qr_points[</span><span class="s4">1</span><span class="s1">] + line_min_width </span><span class="s2">and</span>
                 <span class="s1">qr_points[</span><span class="s4">2</span><span class="s1">] - line_min_width &lt; y &lt; qr_points[</span><span class="s4">3</span><span class="s1">] + line_min_width)</span>
    <span class="s2">if </span><span class="s1">inside_qr:</span>
        <span class="s2">return False</span>
    <span class="s1">inside_header = (y &lt; a_height * </span><span class="s4">0.1</span><span class="s1">)</span>
    <span class="s2">if </span><span class="s1">inside_header:</span>
        <span class="s2">return False</span>
    <span class="s1">wrong_size = (w &gt; line_min_width * </span><span class="s4">1.4 </span><span class="s2">or </span><span class="s1">h &gt; line_min_width * </span><span class="s4">1.4 </span><span class="s2">or</span>
                  <span class="s1">w &lt; line_min_width * </span><span class="s4">0.6 </span><span class="s2">or </span><span class="s1">h &lt; line_min_width * </span><span class="s4">0.6</span><span class="s1">)</span>
    <span class="s2">if </span><span class="s1">wrong_size:</span>
        <span class="s2">return False</span>
    <span class="s1">is_new = </span><span class="s2">True</span>
    <span class="s2">for </span><span class="s1">box </span><span class="s2">in </span><span class="s1">stats:</span>
        <span class="s2">if </span><span class="s1">box[</span><span class="s4">0</span><span class="s1">] &lt; x &lt; (box[</span><span class="s4">0</span><span class="s1">] + box[</span><span class="s4">2</span><span class="s1">]) </span><span class="s2">and </span><span class="s1">box[</span><span class="s4">1</span><span class="s1">] &lt; y &lt; (box[</span><span class="s4">1</span><span class="s1">] + box[</span><span class="s4">3</span><span class="s1">]):</span>
            <span class="s1">is_new = </span><span class="s2">False</span>
        <span class="s2">elif </span><span class="s1">x &lt; box[</span><span class="s4">0</span><span class="s1">] &lt; (x + w) </span><span class="s2">and </span><span class="s1">y &lt; box[</span><span class="s4">1</span><span class="s1">] &lt; (y + h):</span>
            <span class="s1">is_new = </span><span class="s2">False</span>
    <span class="s2">return </span><span class="s1">is_new</span>
<span class="s0">#%% 
</span><span class="s2">def </span><span class="s1">analyse_page(file</span><span class="s2">, </span><span class="s1">dpi</span><span class="s2">, </span><span class="s1">page</span><span class="s2">, </span><span class="s1">qr_coordinates):</span>
    <span class="s1">img = cv2.imread(file)</span>
    <span class="s1">line_min_width = int(dpi * </span><span class="s4">0.14</span><span class="s1">)</span>
    <span class="s1">a_height</span><span class="s2">, </span><span class="s1">a_width = dpi * </span><span class="s4">11.6</span><span class="s2">, </span><span class="s1">dpi * </span><span class="s4">8.3</span>
    <span class="s1">data = {</span><span class="s3">'page'</span><span class="s1">: page</span><span class="s2">, </span><span class="s3">'boxes'</span><span class="s1">: []}</span>
    <span class="s1">qr_points = [qr_coordinates[</span><span class="s4">0</span><span class="s1">][</span><span class="s4">0</span><span class="s1">][</span><span class="s4">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">qr_coordinates[</span><span class="s4">0</span><span class="s1">][</span><span class="s4">1</span><span class="s1">][</span><span class="s4">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">qr_coordinates[</span><span class="s4">0</span><span class="s1">][</span><span class="s4">0</span><span class="s1">][</span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">qr_coordinates[</span><span class="s4">0</span><span class="s1">][</span><span class="s4">2</span><span class="s1">][</span><span class="s4">1</span><span class="s1">]]</span>
    <span class="s0"># grayscale, blur and sharpen</span>
    <span class="s1">gray_scale = cv2.cvtColor(img</span><span class="s2">, </span><span class="s1">cv2.COLOR_BGR2GRAY)</span>
    <span class="s1">blur = cv2.GaussianBlur(gray_scale</span><span class="s2">, </span><span class="s1">(</span><span class="s4">5</span><span class="s2">, </span><span class="s4">5</span><span class="s1">)</span><span class="s2">, </span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">sharpen = cv2.filter2D(blur</span><span class="s2">, </span><span class="s1">-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">np.array([[-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">]]))</span>
    <span class="s1">_</span><span class="s2">, </span><span class="s1">img_bin = cv2.threshold(sharpen</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">225</span><span class="s2">, </span><span class="s1">cv2.THRESH_BINARY + cv2.THRESH_OTSU)</span>
    <span class="s1">img_bin = ~img_bin</span>
    <span class="s0"># filter the image to keep only horizontal and vertical lines of at least line_min_width</span>
    <span class="s1">kernel_h = np.ones((</span><span class="s4">1</span><span class="s2">, </span><span class="s1">line_min_width)</span><span class="s2">, </span><span class="s1">np.uint8)</span>
    <span class="s1">kernel_v = np.ones((line_min_width</span><span class="s2">, </span><span class="s4">1</span><span class="s1">)</span><span class="s2">, </span><span class="s1">np.uint8)</span>
    <span class="s1">img_bin_h = cv2.morphologyEx(img_bin</span><span class="s2">, </span><span class="s1">cv2.MORPH_OPEN</span><span class="s2">, </span><span class="s1">kernel_h)</span>
    <span class="s1">img_bin_v = cv2.morphologyEx(img_bin</span><span class="s2">, </span><span class="s1">cv2.MORPH_OPEN</span><span class="s2">, </span><span class="s1">kernel_v)</span>
    <span class="s1">img_bin_final = img_bin_h | img_bin_v</span>
    <span class="s0"># find contours in the filtered image</span>
    <span class="s1">contours</span><span class="s2">, </span><span class="s1">hierarchy = cv2.findContours(~img_bin_final</span><span class="s2">, </span><span class="s1">cv2.RETR_TREE</span><span class="s2">, </span><span class="s1">cv2.CHAIN_APPROX_SIMPLE)</span>
    <span class="s1">contours = contours[::-</span><span class="s4">1</span><span class="s1">]   </span><span class="s0"># [::-1] because the order is reversed</span>
    <span class="s1">stats = []</span>
    <span class="s2">for </span><span class="s1">contour </span><span class="s2">in </span><span class="s1">contours:</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">w</span><span class="s2">, </span><span class="s1">h = cv2.boundingRect(contour)</span>
        <span class="s2">if </span><span class="s1">is_valid_box(x</span><span class="s2">,</span><span class="s1">y</span><span class="s2">,</span><span class="s1">w</span><span class="s2">,</span><span class="s1">h</span><span class="s2">,</span><span class="s1">qr_points</span><span class="s2">,</span><span class="s1">line_min_width</span><span class="s2">,</span><span class="s1">a_height</span><span class="s2">,</span><span class="s1">stats):</span>
            <span class="s1">stats.append([x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">w</span><span class="s2">, </span><span class="s1">h])</span>
    <span class="s0"># check if the boxes are marked and store the data</span>
    <span class="s2">for </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">w</span><span class="s2">, </span><span class="s1">h </span><span class="s2">in </span><span class="s1">stats:</span>
        <span class="s0"># get the inside of the box from the inverted grayscale image and check if it is marked</span>
        <span class="s1">x2</span><span class="s2">, </span><span class="s1">y2 = x + w</span><span class="s2">, </span><span class="s1">y + h</span>
        <span class="s1">box = {</span><span class="s3">'stats'</span><span class="s1">: [x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">w</span><span class="s2">, </span><span class="s1">h]</span><span class="s2">, </span><span class="s3">'page'</span><span class="s1">: page}</span>
        <span class="s1">inner_box = img_bin[y:y2</span><span class="s2">, </span><span class="s1">x:x2]</span>
        <span class="s1">box[</span><span class="s3">'is_marked'</span><span class="s1">] = is_marked(inner_box</span><span class="s2">, </span><span class="s1">w</span><span class="s2">, </span><span class="s1">h)</span>
        <span class="s1">data[</span><span class="s3">'boxes'</span><span class="s1">].append(box)</span>
    <span class="s2">return </span><span class="s1">data</span>
<span class="s0">#%% 
</span><span class="s2">def </span><span class="s1">is_marked(inner_box</span><span class="s2">, </span><span class="s1">width</span><span class="s2">, </span><span class="s1">height</span><span class="s2">, </span><span class="s1">b_th=</span><span class="s4">0.1</span><span class="s2">, </span><span class="s1">validation_th = </span><span class="s4">0.1</span><span class="s1">):</span>
    <span class="s0"># ignore the pixels closest to the border, to avoid noise</span>
    <span class="s1">x_min = int(width * b_th)</span>
    <span class="s1">y_min = int(height * b_th)</span>
    <span class="s1">x_max = width - x_min</span>
    <span class="s1">y_max = height - y_min</span>
    <span class="s1">area = x_max * y_max</span>
    <span class="s1">inner_box = inner_box[y_min:y_max</span><span class="s2">, </span><span class="s1">x_min:x_max]</span>
    <span class="s0"># get sum of colored pixels, box is considered full if sum is greater than 10% of area</span>
    <span class="s1">bits_filled = [[(</span><span class="s4">0 </span><span class="s2">if </span><span class="s1">i &lt; </span><span class="s4">100 </span><span class="s2">else </span><span class="s4">1</span><span class="s1">) </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">j] </span><span class="s2">for </span><span class="s1">j </span><span class="s2">in </span><span class="s1">inner_box]</span>
    <span class="s1">add = reduce(</span><span class="s2">lambda </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b: a + b</span><span class="s2">, </span><span class="s1">[reduce(</span><span class="s2">lambda </span><span class="s1">c</span><span class="s2">, </span><span class="s1">d: c + d</span><span class="s2">, </span><span class="s1">row) </span><span class="s2">for </span><span class="s1">row </span><span class="s2">in </span><span class="s1">bits_filled])</span>
    <span class="s2">return </span><span class="s1">add &gt; (area * validation_th)</span>

<span class="s0">#%% md 
</span><span class="s1">## pruebas con examenes escaneados 
</span><span class="s0">#%% 
</span><span class="s1">scan1x5 = analyse(</span><span class="s3">'scanned/scanned_11111.pdf'</span><span class="s1">)</span>
<span class="s1">scan1x5</span>
<span class="s0">#%% md 
</span><span class="s1">examen con paginas desordenadas: 1, 3, 2 
</span><span class="s0">#%% 
</span><span class="s1">scan1x5_desorden = analyse(</span><span class="s3">'scanned/scanned_11111_desordenado.pdf'</span><span class="s1">)</span>
<span class="s1">scan1x5_desorden</span>
<span class="s0">#%% 
</span><span class="s1">scan2x5 = analyse(</span><span class="s3">'scanned/scanned_22222.pdf'</span><span class="s1">)</span>
<span class="s1">scan2x5</span>
<span class="s0">#%% md 
</span><span class="s1">## pruebas con examenes rellenados con editor pdf 
</span><span class="s0">#%% 
</span><span class="s1">filled1x5 = analyse(</span><span class="s3">'filled/question_11111.pdf'</span><span class="s1">)</span>
<span class="s1">filled1x5</span>
<span class="s0">#%% 
</span><span class="s1">filled2x5 = analyse(</span><span class="s3">'filled/question_22222.pdf'</span><span class="s1">)</span>
<span class="s1">filled2x5</span>
<span class="s0">#%% 
</span></pre>
</body>
</html>